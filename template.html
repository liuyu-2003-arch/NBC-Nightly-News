<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{TITLE}} - NBC English Learning</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding-bottom: 240px; background: #f4f4f5; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; background: white; min-height: 100vh; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { color: #333; }
        .meta { color: #888; margin-bottom: 20px; }

        /* 字幕区域 */
        .lyrics-container { line-height: 1.8; font-size: 18px; color: #555; }
        .line { padding: 10px 15px; margin-bottom: 10px; border-radius: 8px; transition: all 0.2s; cursor: pointer; border-left: 4px solid transparent; }
        .line:hover { background: #f0f0f0; }

        /* 高亮样式 */
        .line.active { background: #e6f7ff; color: #000; font-weight: 500; border-left-color: #1890ff; transform: scale(1.02); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

        /* 底部固定播放器 */
        .player-dock {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 220px;
            background: #222; z-index: 1000; box-shadow: 0 -4px 10px rgba(0,0,0,0.2);
            display: flex; justify-content: center; align-items: center;
        }
        /* 响应式调整：手机上播放器稍微高一点 */
        @media (max-width: 600px) { .player-dock { height: 200px; } body { padding-bottom: 200px; } }

        #player { width: 100%; max-width: 800px; height: 100%; }
    </style>
</head>
<body>

<div class="container">
    <a href="../../index.html" style="text-decoration:none; color:#1890ff;">&larr; 返回首页</a>
    <h1>{{TITLE}}</h1>
    <div class="meta">发布日期: {{DATE}}</div>

    <div id="lyrics" class="lyrics-container">
        </div>
</div>

<div class="player-dock">
    <div id="player"></div>
</div>

<script>
    // 1. 数据注入 (由 Python 替换)
    const subtitles = {{SUBTITLES_JSON}};
    const videoId = "{{VIDEO_ID}}";

    // 2. 渲染字幕 HTML
    const lyricsDiv = document.getElementById('lyrics');
    subtitles.forEach((sub, index) => {
        const div = document.createElement('div');
        div.className = 'line';
        div.id = 'line-' + index;
        div.innerHTML = sub.text; // 允许 <br> 标签
        div.onclick = () => seekTo(sub.start);
        lyricsDiv.appendChild(div);
    });

    // 3. YouTube API
    var player;
    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            videoId: videoId,
            playerVars: { 'playsinline': 1 },
            events: {
                'onReady': onPlayerReady,
                'onStateChange': onPlayerStateChange
            }
        });
    }

    function onPlayerReady(event) {
        // 播放器准备就绪
    }

    // 4. 同步逻辑
    let interval;
    function onPlayerStateChange(event) {
        if (event.data == YT.PlayerState.PLAYING) {
            interval = setInterval(syncLyrics, 100);
        } else {
            clearInterval(interval);
        }
    }

    function syncLyrics() {
        const currentTime = player.getCurrentTime();

        // 找到当前应该显示的字幕
        const activeIndex = subtitles.findIndex(sub => currentTime >= sub.start && currentTime < sub.end);

        // 移除旧的高亮
        document.querySelectorAll('.line.active').forEach(el => el.classList.remove('active'));

        if (activeIndex !== -1) {
            const activeEl = document.getElementById('line-' + activeIndex);
            activeEl.classList.add('active');

            // 自动滚动 (保持当前行在视口中间偏上)
            activeEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    function seekTo(seconds) {
        if (player && player.seekTo) {
            player.seekTo(seconds, true);
            player.playVideo();
        }
    }

    // 加载 YouTube Iframe API
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
</script>
</body>
</html>