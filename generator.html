<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>NBC News 网页生成器</title>
    <style>
        body { font-family: sans-serif; padding: 40px; max-width: 600px; margin: 0 auto; background: #f0f2f5; }
        .card { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { margin-top: 0; color: #333; }
        label { display: block; margin-top: 15px; font-weight: bold; color: #555; }
        input[type="text"], input[type="file"] { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        button { margin-top: 25px; width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; transition: background 0.2s; }
        button:hover { background: #0056b3; }
        .hint { font-size: 12px; color: #888; margin-top: 5px; }
    </style>
</head>
<body>

<div class="card">
    <h1>制作单集学习页</h1>
    <p>输入信息，生成一个独立的 HTML 文件。</p>

    <label>1. 页面标题 (例如: NBC News Dec 08)</label>
    <input type="text" id="pageTitle" placeholder="请输入标题...">

    <label>2. YouTube 链接</label>
    <input type="text" id="videoUrl" placeholder="https://www.youtube.com/watch?v=..." value="https://www.youtube.com/watch?v=rcqpkftnfeY">

    <label>3. 上传字幕文件 (.srt)</label>
    <input type="file" id="srtFile" accept=".srt">

    <button onclick="generatePage()">生成并下载网页</button>
</div>

<script>
    function generatePage() {
        const title = document.getElementById('pageTitle').value || "NBC English Study";
        const url = document.getElementById('videoUrl').value;
        const fileInput = document.getElementById('srtFile').files[0];

        if (!url || !fileInput) {
            alert("请确保填写了链接并上传了字幕文件！");
            return;
        }

        const videoId = extractVideoID(url);
        if (!videoId) {
            alert("YouTube 链接格式不正确");
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            const srtContent = e.target.result;
            const parsedSubtitles = parseSRT(srtContent);

            // 将数据注入模板
            const finalHtml = getTemplate(title, videoId, JSON.stringify(parsedSubtitles));

            // 触发下载
            downloadFile(`${title.replace(/\s+/g, '_')}.html`, finalHtml);
        };
        reader.readAsText(fileInput);
    }

    // --- 核心逻辑 ---

    function parseSRT(data) {
        const subs = [];
        const blocks = data.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n\n');
        blocks.forEach(block => {
            const lines = block.trim().split('\n');
            if (lines.length >= 3) {
                const timeLineIndex = lines.findIndex(l => l.includes('-->'));
                if (timeLineIndex !== -1) {
                    const [startStr, endStr] = lines[timeLineIndex].split('-->');
                    // 简单的源标签清理
                    const textLines = lines.slice(timeLineIndex + 1);
                    let text = textLines.join('\n').replace(/\/g, '');

                    subs.push({
                        start: timeToSeconds(startStr.trim()),
                        end: timeToSeconds(endStr.trim()),
                        text: text
                    });
                }
            }
        });
        return subs;
    }

    function timeToSeconds(timeStr) {
        const parts = timeStr.split(':');
        const secParts = parts[2].split(',');
        return (parseInt(parts[0])*3600) + (parseInt(parts[1])*60) + parseInt(secParts[0]) + (parseInt(secParts[1])/1000);
    }

    function extractVideoID(url) {
        const reg = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
        const match = url.match(reg);
        return (match && match[2].length === 11) ? match[2] : null;
    }

    function downloadFile(filename, content) {
        const element = document.createElement('a');
        element.setAttribute('href', 'data:text/html;charset=utf-8,' + encodeURIComponent(content));
        element.setAttribute('download', filename);
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
    }

    // --- 独立的网页模板 ---
    // 下面这个字符串就是生成的网页的所有代码
    function getTemplate(pageTitle, videoId, subtitlesJson) {
        return `<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>${pageTitle}</title>
<style>
    body { margin: 0; padding: 0; font-family: 'Helvetica Neue', Arial, sans-serif; background: #f8f9fa; height: 100vh; display: flex; flex-direction: column; }
    .header { background: #fff; padding: 15px 20px; border-bottom: 1px solid #ddd; display:flex; justify-content:space-between; align-items:center; }
    .header h2 { margin: 0; font-size: 18px; color: #333; }
    .home-link { text-decoration: none; color: #007bff; font-size: 14px; }
    #lyrics-container { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 220px; text-align: center; scroll-behavior: smooth; }
    .subtitle-line { padding: 12px 20px; margin: 8px auto; max-width: 800px; border-radius: 8px; cursor: pointer; transition: all 0.2s; color: #555; background: white; border-left: 4px solid transparent; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .subtitle-line:hover { background-color: #e9ecef; }
    .subtitle-line.active { color: #000; font-weight: bold; font-size: 1.1em; background-color: #e3f2fd; border-left: 4px solid #007bff; transform: scale(1.02); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .time-tag { font-size: 0.75em; color: #adb5bd; display: block; margin-bottom: 4px; }
    .text-content { line-height: 1.6; white-space: pre-wrap; }
    .footer-player { position: fixed; bottom: 0; left: 0; width: 100%; height: 200px; background: #000; z-index: 20; box-shadow: 0 -2px 10px rgba(0,0,0,0.2); }
    #player { width: 100%; height: 100%; }
    @media (max-width: 600px) { .footer-player { height: 180px; } #lyrics-container { padding-bottom: 200px; } }
</style>
</head>
<body>

<div class="header">
    <h2>${pageTitle}</h2>
    </div>

<div id="lyrics-container"></div>

<div class="footer-player">
    <div id="player"></div>
</div>

<script>
    // --- 硬编码的数据 ---
    const VIDEO_ID = "${videoId}";
    const SUBTITLES = ${subtitlesJson};

    // --- 播放器逻辑 ---
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    var player;
    var timerInterval;
    var isAutoScrolling = true;

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            videoId: VIDEO_ID,
            playerVars: { 'playsinline': 1, 'controls': 1 },
            events: {
                'onReady': onPlayerReady,
                'onStateChange': onPlayerStateChange
            }
        });
    }

    function onPlayerReady(event) {
        renderSubtitles();
        startSyncLoop();
    }

    function onPlayerStateChange(event) {
        if (event.data == YT.PlayerState.PLAYING) startSyncLoop();
        else stopSyncLoop();
    }

    function startSyncLoop() {
        stopSyncLoop();
        timerInterval = setInterval(() => {
            if (!player || !player.getCurrentTime) return;
            highlightSubtitle(player.getCurrentTime());
        }, 100);
    }

    function stopSyncLoop() { clearInterval(timerInterval); }

    function highlightSubtitle(time) {
        const activeIndex = SUBTITLES.findIndex(sub => time >= sub.start && time <= sub.end);
        if (activeIndex !== -1) {
            const currentActive = document.querySelector('.subtitle-line.active');
            if (currentActive && currentActive.dataset.index != activeIndex) {
                currentActive.classList.remove('active');
            }
            const newActive = document.getElementById('sub-' + activeIndex);
            if (newActive && !newActive.classList.contains('active')) {
                newActive.classList.add('active');
                if (isAutoScrolling) newActive.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    }

    function renderSubtitles() {
        const container = document.getElementById('lyrics-container');
        SUBTITLES.forEach((sub, index) => {
            const div = document.createElement('div');
            div.className = 'subtitle-line';
            div.id = 'sub-' + index;
            div.dataset.index = index;
            div.onclick = () => { player.seekTo(sub.start); player.playVideo(); };
            div.innerHTML = \`<span class="time-tag">#\${index + 1}</span><div class="text-content">\${sub.text}</div>\`;
            container.appendChild(div);
        });
    }

    // 监听用户手动滚动以暂停自动滚动（可选）
    let scrollTimeout;
    document.getElementById('lyrics-container').addEventListener('scroll', () => {
        isAutoScrolling = false;
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => { isAutoScrolling = true; }, 3000);
    });
<\/script>
</body>
</html>`;
    }
</script>
</body>
</html>